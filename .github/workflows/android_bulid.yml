name: Android Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build & Release APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Get Dependencies
        run: flutter pub get

      # NOTE: We can skip creating the .env file now because we pass keys directly below

      - name: Build APK
        # UPDATED: We inject the secrets directly into the build command here
        run: |
          flutter build apk --release \
            --dart-define=SUPABASE_URL="${{ secrets.SUPABASE_URL }}" \
            --dart-define=SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}"

      - name: Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > release-keystore.jks

      - name: Sign APK
        id: sign_apk
        run: |
          # 1. Find the build tools
          BUILD_TOOLS_PATH=$ANDROID_HOME/build-tools/$(ls $ANDROID_HOME/build-tools | sort -V | tail -n 1)
          
          # 2. Find the APK file
          APK_PATH=$(find build/app/outputs -name "*-release.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "Error: APK not found"
            exit 1
          fi
          echo "Found APK: $APK_PATH"

          # 3. Load secrets into variables
          KEY_ALIAS="${{ secrets.ANDROID_KEY_ALIAS }}"
          KS_PASS="${{ secrets.ANDROID_KEYSTORE_PASSWORD }}"
          KEY_PASS="${{ secrets.ANDROID_KEY_PASSWORD }}"

          # 4. Sign the APK
          $BUILD_TOOLS_PATH/apksigner sign \
            --ks release-keystore.jks \
            --ks-key-alias "$KEY_ALIAS" \
            --ks-pass "pass:$KS_PASS" \
            --key-pass "pass:$KEY_PASS" \
            "$APK_PATH"

          # 5. Save path
          echo "SIGNED_APK_PATH=$APK_PATH" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.SIGNED_APK_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}