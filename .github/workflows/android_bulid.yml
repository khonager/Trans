name: Android Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build & Release APK
    runs-on: ubuntu-latest

    # FIX: Grant permission to create Releases and upload files
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Get Dependencies
        run: flutter pub get

      # 1. Inject Secrets Safely
      - name: Inject Secrets
        run: |
          touch .env
          
          URL="${{ secrets.SUPABASE_URL }}"
          KEY="${{ secrets.SUPABASE_ANON_KEY }}"
          
          # Sanitize
          URL=$(echo "$URL" | tr -d '\n' | xargs)
          KEY=$(echo "$KEY" | tr -d '\n' | xargs)

          # Write AppConfig
          cat <<EOF > lib/config/app_config.dart
          import 'package:flutter_dotenv/flutter_dotenv.dart';

          class AppConfig {
            static String get supabaseUrl => r"$URL";
            static String get supabaseAnonKey => r"$KEY";
          }
          EOF

      - name: Build APK
        run: flutter build apk --release

      - name: Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > release-keystore.jks

      - name: Sign APK
        id: sign_apk
        run: |
          BUILD_TOOLS_PATH=$ANDROID_HOME/build-tools/$(ls $ANDROID_HOME/build-tools | sort -V | tail -n 1)
          
          APK_PATH=$(find build/app/outputs -name "*-release.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "Error: APK not found"
            exit 1
          fi
          
          # 2. Sanitize Signing Keys (Remove hidden newlines)
          KEY_ALIAS=$(echo "${{ secrets.ANDROID_KEY_ALIAS }}" | tr -d '\r' | tr -d '\n')
          KS_PASS=$(echo "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" | tr -d '\r' | tr -d '\n')
          KEY_PASS=$(echo "${{ secrets.ANDROID_KEY_PASSWORD }}" | tr -d '\r' | tr -d '\n')

          $BUILD_TOOLS_PATH/apksigner sign \
            --ks release-keystore.jks \
            --ks-key-alias "$KEY_ALIAS" \
            --ks-pass "pass:$KS_PASS" \
            --key-pass "pass:$KEY_PASS" \
            "$APK_PATH"

          echo "SIGNED_APK_PATH=$APK_PATH" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.SIGNED_APK_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}