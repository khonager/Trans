name: Android Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build & Release APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Get Dependencies
        run: flutter pub get

      # FIX: Inject secrets safely into AppConfig to prevent build crashes
      - name: Inject Secrets
        run: |
          # 1. Create a dummy .env file so dotenv.load() doesn't crash at runtime
          touch .env

          # 2. Read secrets into shell variables
          URL="${{ secrets.SUPABASE_URL }}"
          KEY="${{ secrets.SUPABASE_ANON_KEY }}"
          
          # 3. Sanitize: Remove newlines to prevent syntax errors in Dart
          URL=$(echo "$URL" | tr -d '\n' | xargs)
          KEY=$(echo "$KEY" | tr -d '\n' | xargs)

          # 4. Overwrite lib/config/app_config.dart with the real keys
          # We use Raw Strings (r"...") to handle special characters safely
          cat <<EOF > lib/config/app_config.dart
          import 'package:flutter_dotenv/flutter_dotenv.dart';

          class AppConfig {
            static String get supabaseUrl => r"$URL";
            static String get supabaseAnonKey => r"$KEY";
          }
          EOF

      - name: Build APK
        run: flutter build apk --release

      - name: Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > release-keystore.jks

      - name: Sign APK
        id: sign_apk
        run: |
          # Find build tools
          BUILD_TOOLS_PATH=$ANDROID_HOME/build-tools/$(ls $ANDROID_HOME/build-tools | sort -V | tail -n 1)
          
          # Find APK
          APK_PATH=$(find build/app/outputs -name "*-release.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "Error: APK not found"
            exit 1
          fi
          
          # Load secrets into variables
          KEY_ALIAS="${{ secrets.ANDROID_KEY_ALIAS }}"
          KS_PASS="${{ secrets.ANDROID_KEYSTORE_PASSWORD }}"
          KEY_PASS="${{ secrets.ANDROID_KEY_PASSWORD }}"

          # Sign APK
          $BUILD_TOOLS_PATH/apksigner sign \
            --ks release-keystore.jks \
            --ks-key-alias "$KEY_ALIAS" \
            --ks-pass "pass:$KS_PASS" \
            --key-pass "pass:$KEY_PASS" \
            "$APK_PATH"

          echo "SIGNED_APK_PATH=$APK_PATH" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.SIGNED_APK_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}